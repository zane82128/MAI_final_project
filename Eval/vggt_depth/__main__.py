from pathlib import Path
from Data.Interface import DepthDataset

from .pipeline import depth_evaluate, EvalauteConfig
from ..common.datautil import slice_dataset


def get_dataset(args) -> DepthDataset:
    match args.dataset:
        case "dtu-mvs":
            from Data.DTU import DTU_DepthDataset, default_root
            dataset   = DTU_DepthDataset(default_root, args.seq_l)
            
        case "eth-3d":
            from Data.ETH3D import ETH3D_Depth_Dataset, default_root
            dataset = ETH3D_Depth_Dataset(default_root, args.seq_l)
            
        case "nyud-v2":
            assert args.seq_l == 1
            from Data.NYUd_v2 import NYUdV2_Depth_Dataset, default_root
            dataset = NYUdV2_Depth_Dataset(default_root)
            
        case "kitti-d":
            from Data.KITTI import KITTIDepthDataset, default_root
            dataset = KITTIDepthDataset(default_root, args.seq_l)
            
        case _: raise ValueError("Unsupported")
    
    return slice_dataset(dataset, args.slice)


def get_model(args):
    match args.model:
        case "vggt": 
            from Network.vggt import get_VGGT_vanilla
            return get_VGGT_vanilla(), None
        
        case "vggt*":
            from Network.vggt import get_VGGT
            return get_VGGT(), None
        
        case "ours":
            from Network.vggt import get_VGGT
            from Accelerate.vggt import accelerate_vggt, Accelerator_Config
            
            mask_setup = (args.mask_setup[0], float(args.mask_setup[1]))
            model = get_VGGT()
            model, get_mask, set_mask = accelerate_vggt(model, Accelerator_Config(
                accelerator=args.accelerator, grp_size=args.grp_size, 
                mask_setup=mask_setup,
                accel_dino_attn  =not args.ablation_no_dino_att_merge ,
                accel_dino_mlp   =not args.ablation_no_dino_mlp_merge ,
                accel_frame_attn =not args.ablation_no_frame_att_merge,
                accel_frame_mlp  =not args.ablation_no_frame_mlp_merge,
                accel_global_attn=not args.ablation_no_globe_att_merge,
                accel_global_mlp =not args.ablation_no_globe_mlp_merge,
                apply_attn_bias  =not args.ablation_no_attn_bias
            ))
            return model, get_mask
        
        case model_type: raise ValueError(f"Unsupported model type: {model_type=}")


def main(args):    
    data            = get_dataset(args)
    model, get_mask = get_model(args)
    depth_evaluate(model, data, EvalauteConfig(infer_shape=(27 * 14, 36 * 14), dataset_name=args.dataset), args.result, args.masks, get_mask)


if __name__ == "__main__":
    import argparse
    parser = argparse.ArgumentParser()
    
    group = parser.add_argument_group("Dataset")
    group.add_argument("--dataset", type=str, choices=['dtu-mvs', 'eth-3d', 'nyud-v2', 'kitti-d'])
    group.add_argument("--seq_l", type=int, metavar="S", help="Length of sequences generated by the dataset")
    group.add_argument("--slice", type=int, metavar="N", default=None, help="Evaluate first N samples of dataset")
    
    subparser = parser.add_subparsers(dest="model")
    
    vggt_parser = subparser.add_parser("vggt" , help="Vanilla VGGT")
    vggts_parser= subparser.add_parser("vggt*", help="VGGT* (VGGT + FlexAttention)")  
    
    ours_vggt_parser = subparser.add_parser("ours", help="Our Acceleration Method")
    ours_vggt_parser.add_argument("--grp_size", type=int)
    ours_vggt_parser.add_argument("--mask_setup" , nargs=2, metavar=("Method", "Threshold"), help="Can be either ('z-score', float) | ('bot-k', int) | ('bot-p', float)")
    ours_vggt_parser.add_argument("--accelerator", type=Path)
    ours_vggt_parser.add_argument("--ablation_no_frame_att_merge", action="store_true")
    ours_vggt_parser.add_argument("--ablation_no_frame_mlp_merge", action="store_true")
    ours_vggt_parser.add_argument("--ablation_no_globe_att_merge", action="store_true")
    ours_vggt_parser.add_argument("--ablation_no_globe_mlp_merge", action="store_true")
    ours_vggt_parser.add_argument("--ablation_no_dino_att_merge", action="store_true")
    ours_vggt_parser.add_argument("--ablation_no_dino_mlp_merge", action="store_true")
    ours_vggt_parser.add_argument("--ablation_no_attn_bias", action="store_true")
    
    parser.add_argument("--result", type=Path, help="Save result json path")
    parser.add_argument("--masks" , type=Path, help="Save mask pth files path")
    
    args = parser.parse_args()

    main(args)
